<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Server List Decoder</title>
</head>
<body>
    <button onclick="fetchAndDecrypt()">Get Server List</button>
    <pre id="output"></pre>

    <script>
        async function decryptAES128CBC(ciphertext, key, iv) {
            try {
                // Convert hex string to ArrayBuffer
                const encryptedBytes = new Uint8Array(
                    ciphertext.match(/.{1,2}/g).map(byte => parseInt(byte, 16))
                );

                // Convert key and IV from strings to ArrayBuffers
                const keyBytes = new TextEncoder().encode(key);
                const ivBytes = new TextEncoder().encode(iv);

                // Import key for Web Crypto
                const cryptoKey = await crypto.subtle.importKey(
                    "raw",
                    keyBytes,
                    { name: "AES-CBC" },
                    false,
                    ["decrypt"]
                );

                // Decrypt
                const decrypted = await crypto.subtle.decrypt(
                    { name: "AES-CBC", iv: ivBytes },
                    cryptoKey,
                    encryptedBytes
                );

                // Convert to Uint8Array and remove padding
                const decryptedBytes = new Uint8Array(decrypted);
                const paddingLength = decryptedBytes[decryptedBytes.length - 1];
                if (paddingLength > 0 && paddingLength <= 16) {
                    return decryptedBytes.slice(0, -paddingLength);
                }
                return decryptedBytes;
            } catch (err) {
                console.error('Decryption error:', err.message);
                return null;
            }
        }

        async function fetchAndDecrypt() {
            const outputElement = document.getElementById('output');
            outputElement.textContent = 'Fetching...';

            const url = 'http://api.skrapp.net/api/serverlist';
            const headers = {
                'accept': '/',
                'accept-language': 'zh-Hans-CN;q=1, en-CN;q=0.9',
                'appversion': '1.3.1',
                'user-agent': 'SkrKK/1.3.1 (iPhone; iOS 13.5; Scale/2.00)',
                'content-type': 'application/x-www-form-urlencoded',
                'Cookie': 'PHPSESSID=fnffo1ivhvt0ouo6ebqn86a0d4'
            };
            const body = 'data=4265a9c353cd8624fd2bc7b5d75d2f18b1b5e66ccd37e2dfa628bcb8f73db2f14ba98bc6a1d8d0d1c7ff1ef0823b11264d0addaba2bd6a30bdefe06f4ba994ed';
            const key = '65151f8d966bf596';
            const iv = '88ca0f0ea1ecf975';

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: body,
                    mode: 'cors',
                    credentials: 'include'
                });

                if (response.ok) {
                    const rawText = await response.text();
                    const trimmedText = rawText.trim();

                    const decryptedBytes = await decryptAES128CBC(trimmedText, key, iv);
                    if (!decryptedBytes) {
                        outputElement.textContent = 'Decryption failed';
                        return;
                    }

                    const decryptedStr = new TextDecoder().decode(decryptedBytes);
                    let result = '';

                    try {
                        const parsedData = JSON.parse(decryptedStr);
                        
                        // Generate UTC timestamp
                        const now = new Date();
                        const timestamp = now.getUTCFullYear() + '-' +
                            String(now.getUTCMonth() + 1).padStart(2, '0') + '-' +
                            String(now.getUTCDate()).padStart(2, '0') + '-' +
                            String(now.getUTCHours()).padStart(2, '0') + '-' +
                            String(now.getUTCMinutes()).padStart(2, '0') + '-' +
                            String(now.getUTCSeconds()).padStart(2, '0');
                        
                        result += `${timestamp}\n`;

                        // Add Shadowsocks URLs
                        for (const server of parsedData.data) {
                            const serverStr = `aes-256-cfb:${server.password}@${server.ip}:${server.port}`;
                            const base64Str = btoa(serverStr);
                            const ssUrl = `ss://${base64Str}#${server.title}`;
                            result += ssUrl + '\n';
                        }

                        outputElement.textContent = result.trim();
                    } catch (jsonErr) {
                        outputElement.textContent = `JSON Parse Error: ${jsonErr.message}\nData: ${decryptedStr}`;
                    }
                } else {
                    outputElement.textContent = `API request failed with status: ${response.status}`;
                }
            } catch (error) {
                outputElement.textContent = `Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>
